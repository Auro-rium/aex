<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AEX v2.0 Local Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2e;
      --line: #22304d;
      --text: #eaf0ff;
      --muted: #93a4c9;
      --ok: #2ec27e;
      --warn: #f6c445;
      --bad: #ff6b6b;
      --accent: #4ea1ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #09101c, var(--bg));
      color: var(--text);
      min-height: 100vh;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 14px 36px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    h1 { margin: 0; font-size: 1.35rem; }
    .muted { color: var(--muted); font-size: .9rem; }
    .btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #18243f;
      color: var(--text);
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
    }
    .grid {
      display: grid;
      gap: 12px;
    }
    .kpis {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 12px;
    }
    .two {
      grid-template-columns: 1fr 1fr;
      margin-bottom: 12px;
    }
    @media (max-width: 860px) {
      .two { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .title {
      color: var(--muted);
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 6px;
    }
    .value { font-size: 1.35rem; font-weight: 700; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 700;
      border: 1px solid;
    }
    .ok { color: var(--ok); border-color: color-mix(in oklab, var(--ok), transparent 55%); }
    .warn { color: var(--warn); border-color: color-mix(in oklab, var(--warn), transparent 55%); }
    .bad { color: var(--bad); border-color: color-mix(in oklab, var(--bad), transparent 55%); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .86rem;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #203051;
      text-align: left;
    }
    th { color: var(--muted); font-weight: 600; }
    code {
      background: #0f1830;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: .8rem;
      color: #b8cdfb;
    }
    .footer { margin-top: 14px; color: var(--muted); font-size: .82rem; }
    .error { color: var(--bad); font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>AEX v2.0 Local Dashboard</h1>
        <div class="muted">Simple local frontend wired to backend admin APIs</div>
      </div>
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>

    <div class="grid kpis" id="kpis"></div>

    <div class="grid two">
      <div class="card">
        <div class="title">Replay Integrity</div>
        <div id="replayStatus" class="muted">Loading...</div>
      </div>
      <div class="card">
        <div class="title">Execution States</div>
        <div id="execStates" class="muted">Loading...</div>
      </div>
    </div>

    <div class="card">
      <div class="title">Recent Executions</div>
      <div style="overflow:auto; max-height: 320px;">
        <table>
          <thead>
            <tr>
              <th>Execution</th>
              <th>Agent</th>
              <th>State</th>
              <th>Status</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="execBody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer" id="foot">Loading...</div>
  </div>

  <script>
    const fmtUsd = (v) => {
      const n = Number(v || 0);
      return `$${n.toFixed(6)}`;
    };

    function statusPill(ok, text) {
      const cls = ok ? 'ok' : 'bad';
      return `<span class="pill ${cls}">${text}</span>`;
    }

    async function fetchJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${url} -> ${r.status}`);
      return await r.json();
    }

    function renderKpis(metrics, health) {
      const cards = [
        ['Version', health.version || '-'],
        ['Agents', metrics.total_agents ?? 0],
        ['Requests', metrics.total_requests ?? 0],
        ['Denied Budget', metrics.total_denied_budget ?? 0],
        ['Denied Rate', metrics.total_denied_rate_limit ?? 0],
        ['Global Spent', fmtUsd(metrics.total_spent_global_usd)],
      ];

      const el = document.getElementById('kpis');
      el.innerHTML = cards.map(([label, val]) => (
        `<div class="card"><div class="title">${label}</div><div class="value">${val}</div></div>`
      )).join('');
    }

    function renderReplay(replay, metrics) {
      const replayEl = document.getElementById('replayStatus');
      const hashOk = !!replay.hash_chain_ok;
      const balanceOk = !!replay.balance_replay_ok;
      const metricsHashOk = !!metrics.hash_chain_ok;
      replayEl.innerHTML = `
        ${statusPill(hashOk, hashOk ? 'Hash Chain PASS' : 'Hash Chain FAIL')}<br>
        <small>${replay.hash_chain_detail || '-'}</small><br><br>
        ${statusPill(balanceOk, balanceOk ? 'Balance Replay PASS' : 'Balance Replay FAIL')}<br>
        <small>${replay.balance_replay_detail || '-'}</small><br><br>
        Metrics view: ${statusPill(metricsHashOk, metricsHashOk ? 'OK' : 'FAIL')}
      `;
    }

    function renderStates(activity) {
      const data = activity.execution_state_counts || {};
      const entries = Object.entries(data);
      const el = document.getElementById('execStates');
      if (!entries.length) {
        el.innerHTML = '<span class="muted">No execution data yet.</span>';
        return;
      }
      el.innerHTML = entries
        .sort((a, b) => b[1] - a[1])
        .map(([k, v]) => `<div><code>${k}</code>: ${v}</div>`)
        .join('');
    }

    function renderExecutions(activity) {
      const body = document.getElementById('execBody');
      const rows = (activity.executions || []).slice(0, 30);
      body.innerHTML = rows.map((r) => `
        <tr>
          <td><code>${r.execution_id || '-'}</code></td>
          <td>${r.agent || '-'}</td>
          <td>${r.state || '-'}</td>
          <td>${r.status_code ?? '-'}</td>
          <td>${r.updated_at || r.created_at || '-'}</td>
        </tr>
      `).join('');
    }

    async function refresh() {
      const foot = document.getElementById('foot');
      try {
        foot.textContent = 'Refreshing...';
        const [health, metrics, replay, activity] = await Promise.all([
          fetchJson('/health'),
          fetchJson('/metrics'),
          fetchJson('/admin/replay'),
          fetchJson('/admin/activity?limit=40'),
        ]);

        renderKpis(metrics, health);
        renderReplay(replay, metrics);
        renderStates(activity);
        renderExecutions(activity);

        foot.textContent = `Updated: ${new Date().toLocaleString()}`;
      } catch (err) {
        foot.innerHTML = `<span class="error">Refresh failed: ${String(err)}</span>`;
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', refresh);
    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>
