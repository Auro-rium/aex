<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEX Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0a0e17;
            color: #e2e8f0;
            padding: 24px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #1e293b;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
        }
        .header h1 span { color: #6366f1; }
        .refresh-badge {
            font-size: 12px;
            color: #64748b;
            background: #1e293b;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 16px;
        }
        .stat-card .label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .stat-card .value {
            font-size: 22px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .stat-card .value.warning { color: #f59e0b; }
        .stat-card .value.danger { color: #ef4444; }
        .stat-card .value.ok { color: #22c55e; }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        th {
            text-align: left;
            padding: 10px 14px;
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            background: #0f172a;
            letter-spacing: 0.5px;
        }
        td {
            padding: 10px 14px;
            font-size: 13px;
            border-top: 1px solid #1e293b;
        }
        .bar-container {
            background: #1e293b;
            border-radius: 4px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .bar-fill.green { background: #22c55e; }
        .bar-fill.yellow { background: #f59e0b; }
        .bar-fill.red { background: #ef4444; }
        .histogram {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 60px;
            background: #111827;
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 24px;
        }
        .histogram .bar {
            flex: 1;
            background: #6366f1;
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.violation { background: #7f1d1d; color: #fca5a5; }
        .badge.ok { background: #14532d; color: #86efac; }
        .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
        .ttb { color: #f59e0b; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1><span>AEX</span> Governance Dashboard</h1>
        <span class="refresh-badge" id="refresh-status">Refreshing...</span>
    </div>

    <div class="stats-grid" id="stats-grid"></div>

    <div class="section-title">Request Activity (24h)</div>
    <div class="histogram" id="histogram"></div>

    <div class="section-title">Agent Enforcement Status</div>
    <table id="agents-table">
        <thead>
            <tr>
                <th>Agent</th>
                <th>Budget</th>
                <th>Spent</th>
                <th>Usage</th>
                <th>Burn Rate</th>
                <th>TTB</th>
                <th>RPM</th>
            </tr>
        </thead>
        <tbody id="agents-body"></tbody>
    </table>

    <script>
        async function refresh() {
            try {
                const res = await fetch('/metrics');
                const d = await res.json();
                
                // Stats grid
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card"><div class="label">Agents</div><div class="value">${d.total_agents}</div></div>
                    <div class="stat-card"><div class="label">Total Spent</div><div class="value">$${d.total_spent_global_usd.toFixed(4)}</div></div>
                    <div class="stat-card"><div class="label">Active Processes</div><div class="value${d.active_processes > 0 ? ' ok' : ''}">${d.active_processes}</div></div>
                    <div class="stat-card"><div class="label">Requests</div><div class="value">${d.total_requests}</div></div>
                    <div class="stat-card"><div class="label">Budget Denials</div><div class="value${d.total_denied_budget > 0 ? ' warning' : ''}">${d.total_denied_budget}</div></div>
                    <div class="stat-card"><div class="label">Rate Denials</div><div class="value${d.total_denied_rate_limit > 0 ? ' warning' : ''}">${d.total_denied_rate_limit}</div></div>
                    <div class="stat-card"><div class="label">Policy Violations</div><div class="value${d.total_policy_violations > 0 ? ' danger' : ''}">${d.total_policy_violations}</div></div>
                `;
                
                // Histogram
                const maxReq = Math.max(1, ...d.usage_histogram.map(h => h.requests));
                document.getElementById('histogram').innerHTML = d.usage_histogram.map(h =>
                    `<div class="bar" style="height: ${Math.max(2, (h.requests / maxReq) * 100)}%" title="${h.hour}: ${h.requests} requests"></div>`
                ).join('');
                
                // Agents table
                document.getElementById('agents-body').innerHTML = d.agents.map(a => {
                    const pct = a.budget_usd > 0 ? ((a.spent_usd / a.budget_usd) * 100) : 0;
                    const barClass = pct > 90 ? 'red' : pct > 70 ? 'yellow' : 'green';
                    const ttb = a.ttb_seconds !== null
                        ? (a.ttb_seconds > 3600 ? `${Math.floor(a.ttb_seconds/3600)}h ${Math.floor((a.ttb_seconds%3600)/60)}m` : `${Math.floor(a.ttb_seconds/60)}m ${a.ttb_seconds%60}s`)
                        : '∞';
                    return `<tr>
                        <td><strong>${a.name}</strong></td>
                        <td class="mono">$${a.budget_usd.toFixed(4)}</td>
                        <td class="mono">$${a.spent_usd.toFixed(4)}</td>
                        <td style="min-width:120px"><div class="bar-container"><div class="bar-fill ${barClass}" style="width:${pct}%"></div></div></td>
                        <td class="mono">${a.burn_rate_micro_per_sec}µ/s</td>
                        <td class="ttb">${ttb}</td>
                        <td class="mono">${a.rpm_limit}</td>
                    </tr>`;
                }).join('');
                
                document.getElementById('refresh-status').textContent = `Updated ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                document.getElementById('refresh-status').textContent = 'Connection error';
            }
        }
        
        refresh();
        setInterval(refresh, 5000);
    </script>
</body>
</html>
