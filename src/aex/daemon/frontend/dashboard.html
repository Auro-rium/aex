<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AEX Backend Playout</title>
  <style>
    :root {
      --bg-0: #08141d;
      --bg-1: #0e2230;
      --bg-2: #173849;
      --ink: #e9f4f0;
      --muted: #9db2aa;
      --ok: #22c373;
      --warn: #e8b735;
      --bad: #ff6666;
      --accent: #37c5b4;
      --accent-2: #5ab5ff;
      --card: rgba(13, 30, 41, 0.8);
      --line: rgba(158, 189, 180, 0.2);
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 620px at 92% -6%, rgba(55, 197, 180, 0.22), transparent 55%),
        radial-gradient(1000px 520px at -8% 18%, rgba(58, 132, 187, 0.2), transparent 55%),
        linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1360px;
      margin: 0 auto;
      padding: 24px 16px 46px;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      animation: rise 380ms ease-out;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      margin: 0;
      font-size: clamp(1.2rem, 2.7vw, 1.85rem);
      letter-spacing: 0.02em;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 2px;
      font-size: 0.92rem;
      max-width: 760px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .btn, .input, .select {
      border: 1px solid var(--line);
      color: var(--ink);
      background: rgba(20, 45, 60, 0.82);
      border-radius: 999px;
      padding: 8px 14px;
      font: 600 0.84rem/1 "Space Grotesk", "Avenir Next", sans-serif;
    }

    .btn {
      cursor: pointer;
      transition: border-color 180ms ease, transform 180ms ease;
    }

    .btn:hover {
      border-color: rgba(55, 197, 180, 0.6);
      transform: translateY(-1px);
    }

    .btn.active {
      border-color: rgba(55, 197, 180, 0.8);
      box-shadow: inset 0 0 0 1px rgba(55, 197, 180, 0.35);
    }

    .input, .select {
      outline: none;
      min-width: 120px;
    }

    .input:focus, .select:focus {
      border-color: rgba(90, 181, 255, 0.75);
      box-shadow: 0 0 0 2px rgba(90, 181, 255, 0.22);
    }

    .mono {
      font-family: "IBM Plex Mono", "JetBrains Mono", monospace;
      font-size: 0.78rem;
    }

    .grid { display: grid; gap: 14px; margin-bottom: 14px; }
    .kpis { grid-template-columns: repeat(auto-fit, minmax(168px, 1fr)); animation: rise 460ms ease-out; }
    .split { grid-template-columns: 1.15fr 1fr; animation: rise 550ms ease-out; }
    .full { animation: rise 640ms ease-out; }

    .card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(4px);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .control-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      align-items: center;
    }

    .control-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-label {
      color: var(--muted);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-left: 8px;
    }

    .kpi-label {
      color: var(--muted);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 5px;
    }

    .kpi-value {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.05;
    }

    .kpi-foot {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--muted);
      min-height: 1em;
    }

    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      border: 1px solid transparent;
      font-family: "IBM Plex Mono", "JetBrains Mono", monospace;
    }

    .ok { color: var(--ok); border-color: rgba(34, 195, 115, 0.45); }
    .warn { color: var(--warn); border-color: rgba(232, 183, 53, 0.45); }
    .bad { color: var(--bad); border-color: rgba(255, 102, 102, 0.45); }

    .status-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 9px; }

    .states { display: grid; gap: 8px; max-height: 280px; overflow: auto; padding-right: 4px; }
    .state-bar-row {
      display: grid;
      grid-template-columns: 120px 1fr 52px;
      gap: 8px;
      align-items: center;
      font-size: 0.84rem;
    }

    .bar-track {
      width: 100%;
      height: 11px;
      border-radius: 8px;
      background: rgba(173, 207, 198, 0.14);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-2), var(--accent));
      border-radius: 8px;
      transition: width 250ms ease;
    }

    .histogram {
      display: flex;
      align-items: end;
      gap: 4px;
      height: 176px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(18, 39, 51, 0.7);
    }

    .hist-bar {
      flex: 1;
      min-width: 8px;
      border-radius: 4px 4px 2px 2px;
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      opacity: 0.92;
      transition: height 200ms ease;
      position: relative;
    }

    .hist-bar:hover::after {
      content: attr(data-label) " - " attr(data-value);
      position: absolute;
      left: -10px;
      bottom: calc(100% + 5px);
      white-space: nowrap;
      padding: 3px 6px;
      border-radius: 6px;
      font-size: 0.68rem;
      border: 1px solid var(--line);
      background: rgba(6, 15, 22, 0.94);
    }

    .table-wrap {
      overflow: auto;
      max-height: 330px;
      border: 1px solid var(--line);
      border-radius: 10px;
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(173, 207, 198, 0.12);
      text-align: left;
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(11, 25, 35, 0.95);
      color: var(--muted);
      font-weight: 600;
      z-index: 1;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.7rem;
      cursor: pointer;
      user-select: none;
    }

    th.sortable::after {
      content: "  <>";
      opacity: 0.6;
      font-size: 0.64rem;
    }

    tr:hover td {
      background: rgba(40, 80, 102, 0.22);
    }

    .timeline {
      display: grid;
      gap: 8px;
      max-height: 360px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      background: rgba(8, 20, 29, 0.78);
    }

    .item {
      border: 1px solid rgba(173, 207, 198, 0.15);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(13, 30, 41, 0.74);
      transition: border-color 170ms ease, transform 170ms ease;
    }

    .item.clickable { cursor: pointer; }
    .item.clickable:hover {
      border-color: rgba(90, 181, 255, 0.45);
      transform: translateY(-1px);
    }

    .item.selected {
      border-color: rgba(55, 197, 180, 0.8);
      box-shadow: inset 0 0 0 1px rgba(55, 197, 180, 0.28);
    }

    .item-head {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .item-title {
      color: var(--ink);
      font-weight: 600;
      font-size: 0.83rem;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .explorer-meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 0.78rem;
    }

    .explorer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .detail {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(10, 23, 33, 0.86);
      max-height: 360px;
      overflow: auto;
      font-size: 0.77rem;
      line-height: 1.4;
    }

    .detail pre {
      margin: 6px 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      color: #c4ece4;
      font-family: "IBM Plex Mono", "JetBrains Mono", monospace;
      font-size: 0.73rem;
    }

    .view-switch {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .hidden { display: none; }

    .empty {
      color: var(--muted);
      font-size: 0.84rem;
      padding: 8px 4px;
    }

    @media (max-width: 1080px) {
      .split { grid-template-columns: 1fr; }
      .explorer-grid { grid-template-columns: 1fr; }
      .state-bar-row { grid-template-columns: 90px 1fr 45px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>AEX Backend Playout</h1>
        <div class="subtitle">Interactive runtime console for execution governance, ledger integrity, and multi-tenant agent operations.</div>
      </div>
      <div class="toolbar">
        <span id="last-updated" class="mono">updating...</span>
        <select id="refresh-interval" class="select" title="refresh interval">
          <option value="2000">2s</option>
          <option value="3000" selected>3s</option>
          <option value="5000">5s</option>
          <option value="10000">10s</option>
        </select>
        <button id="toggle-refresh" class="btn" type="button">Pause</button>
        <button id="refresh-now" class="btn" type="button">Refresh</button>
      </div>
    </div>

    <div class="grid full">
      <div class="card">
        <h2>Live Filters</h2>
        <div class="control-grid">
          <div class="control-cell">
            <label class="control-label" for="filter-query">Search</label>
            <input id="filter-query" class="input mono" type="text" placeholder="execution / agent / endpoint">
          </div>
          <div class="control-cell">
            <label class="control-label" for="filter-state">Execution State</label>
            <select id="filter-state" class="select mono"></select>
          </div>
          <div class="control-cell">
            <label class="control-label" for="filter-agent">Agent</label>
            <select id="filter-agent" class="select mono"></select>
          </div>
          <div class="control-cell">
            <label class="control-label" for="filter-events">Event Source</label>
            <select id="filter-events" class="select mono">
              <option value="all">all</option>
              <option value="ledger">ledger</option>
              <option value="compat">compat</option>
            </select>
          </div>
          <div class="control-cell" style="justify-content:end;">
            <label class="control-label">Actions</label>
            <button id="clear-filters" class="btn" type="button">Clear Filters</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid kpis">
      <div class="card">
        <div class="kpi-label">Daemon</div>
        <div id="daemon-status" class="kpi-value">-</div>
        <div id="daemon-version" class="kpi-foot mono"></div>
      </div>
      <div class="card">
        <div class="kpi-label">Requests</div>
        <div id="total-requests" class="kpi-value">-</div>
        <div id="total-denials" class="kpi-foot">-</div>
      </div>
      <div class="card">
        <div class="kpi-label">Spend</div>
        <div id="spent-usd" class="kpi-value">$0.000000</div>
        <div id="exec-total" class="kpi-foot">Executions: -</div>
      </div>
      <div class="card">
        <div class="kpi-label">Tenancy</div>
        <div id="tenant-total" class="kpi-value">-</div>
        <div id="project-total" class="kpi-foot">Projects: -</div>
      </div>
      <div class="card">
        <div class="kpi-label">Reservations</div>
        <div id="stale-res" class="kpi-value">-</div>
        <div id="active-proc" class="kpi-foot">Active processes: -</div>
      </div>
      <div class="card">
        <div class="kpi-label">Integrity</div>
        <div id="integrity-state" class="kpi-value">-</div>
        <div class="status-row">
          <span id="hash-pill" class="pill">hash</span>
          <span id="replay-pill" class="pill">replay</span>
        </div>
      </div>
    </div>

    <div class="grid split">
      <div class="card">
        <h2>Execution States</h2>
        <div id="state-bars" class="states"></div>
      </div>
      <div class="card">
        <h2>Requests Last 24h</h2>
        <div id="histogram" class="histogram"></div>
      </div>
    </div>

    <div class="grid split">
      <div class="card">
        <h2>Agent Financials</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-sort="name">Agent</th>
                <th class="sortable" data-sort="spent_usd">Spent</th>
                <th class="sortable" data-sort="remaining_usd">Remaining</th>
                <th class="sortable" data-sort="budget_usd">Budget</th>
                <th class="sortable" data-sort="reserved_usd">Reserved</th>
                <th class="sortable" data-sort="burn">Burn (1m)</th>
              </tr>
            </thead>
            <tbody id="agent-rows"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2>Execution Explorer</h2>
        <div class="explorer-meta">
          <span id="execution-count" class="mono">0 executions</span>
          <label class="mono"><input id="focus-selected" type="checkbox"> focus events on selected</label>
        </div>
        <div class="explorer-grid">
          <div id="execution-list" class="timeline"></div>
          <div id="execution-detail" class="detail mono"></div>
        </div>
      </div>
    </div>

    <div class="grid full">
      <div class="card">
        <h2>Ledger & Control Events</h2>
        <div class="view-switch">
          <button id="view-timeline" class="btn active" type="button">Timeline</button>
          <button id="view-table" class="btn" type="button">Table</button>
        </div>
        <div id="events-timeline" class="timeline"></div>
        <div id="events-table" class="table-wrap hidden">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Source</th>
                <th>Type</th>
                <th>Agent</th>
                <th>Execution</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="event-rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const state = {
      pollMs: 3000,
      polling: true,
      timer: null,
      eventView: "timeline",
      filters: {
        query: "",
        execState: "ALL",
        agent: "ALL",
        eventSource: "all",
      },
      sort: {
        key: "spent_usd",
        dir: "desc",
      },
      selectedExecutionId: null,
      raw: null,
    };

    const $ = (id) => document.getElementById(id);
    const safe = (v) => (v === null || v === undefined ? "" : String(v));
    const lower = (v) => safe(v).toLowerCase();
    const usd = (v) => `$${Number(v || 0).toFixed(6)}`;

    function esc(value) {
      return safe(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function pillClass(ok, unknown = false) {
      if (unknown) return "pill warn";
      return ok ? "pill ok" : "pill bad";
    }

    function setText(id, value) {
      const node = $(id);
      if (node) node.textContent = value;
    }

    function setStatusMessage(text, error = false) {
      const msg = $("last-updated");
      msg.textContent = text;
      msg.style.color = error ? "#ff9c9c" : "";
    }

    function createExecutionStateBars(stateMap) {
      const wrap = $("state-bars");
      wrap.innerHTML = "";

      const entries = Object.entries(stateMap || {});
      if (!entries.length) {
        wrap.innerHTML = '<div class="empty">No execution state data yet.</div>';
        return;
      }

      const max = Math.max(...entries.map(([, n]) => Number(n || 0)), 1);
      entries
        .sort((a, b) => Number(b[1]) - Number(a[1]))
        .forEach(([name, count]) => {
          const row = document.createElement("div");
          row.className = "state-bar-row";
          const width = Math.max(2, Math.round((Number(count || 0) / max) * 100));
          row.innerHTML = `
            <span class="mono">${esc(name)}</span>
            <span class="bar-track"><span class="bar-fill" style="width:${width}%"></span></span>
            <span class="mono">${esc(count)}</span>
          `;
          wrap.appendChild(row);
        });
    }

    function createHistogram(histogram) {
      const wrap = $("histogram");
      wrap.innerHTML = "";
      const rows = Array.isArray(histogram) ? histogram : [];
      if (!rows.length) {
        wrap.innerHTML = '<div class="empty">No usage histogram data yet.</div>';
        return;
      }
      const max = Math.max(...rows.map((r) => Number(r.requests || 0)), 1);
      rows.forEach((r) => {
        const bar = document.createElement("div");
        bar.className = "hist-bar";
        bar.style.height = `${Math.max(4, (Number(r.requests || 0) / max) * 100)}%`;
        bar.dataset.label = safe(r.hour);
        bar.dataset.value = `${safe(r.requests)} req`;
        wrap.appendChild(bar);
      });
    }

    function hydrateSelect(selectId, values, selected) {
      const node = $(selectId);
      if (!node) return;
      const old = selected || node.value || "ALL";
      const options = ["ALL", ...Array.from(new Set(values)).sort((a, b) => a.localeCompare(b))];
      node.innerHTML = options.map((v) => `<option value="${esc(v)}">${esc(v)}</option>`).join("");
      node.value = options.includes(old) ? old : "ALL";
    }

    function getFilteredExecutions(data) {
      const executions = data?.activity?.executions || [];
      const query = lower(state.filters.query.trim());
      const wantedState = state.filters.execState;
      const wantedAgent = state.filters.agent;

      return executions
        .filter((e) => {
          if (wantedState !== "ALL" && safe(e.state) !== wantedState) return false;
          if (wantedAgent !== "ALL" && safe(e.agent) !== wantedAgent) return false;
          if (!query) return true;
          const hay = `${safe(e.execution_id)} ${safe(e.agent)} ${safe(e.endpoint)} ${safe(e.state)}`.toLowerCase();
          return hay.includes(query);
        })
        .sort((a, b) => safe(b.updated_at || b.created_at).localeCompare(safe(a.updated_at || a.created_at)));
    }

    function buildReservationMap(data) {
      return new Map((data?.activity?.reservations || []).map((r) => [safe(r.execution_id), r]));
    }

    function renderAgents(agents, burnRateWindows) {
      const tbody = $("agent-rows");
      tbody.innerHTML = "";
      if (!Array.isArray(agents) || !agents.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No agents found.</td></tr>';
        return;
      }

      const rows = agents.map((a) => {
        const burn = burnRateWindows?.[a.name]?.["1m"] ?? 0;
        return { ...a, burn };
      });

      const key = state.sort.key;
      const dir = state.sort.dir === "asc" ? 1 : -1;
      rows.sort((a, b) => {
        const av = a[key] ?? "";
        const bv = b[key] ?? "";
        if (typeof av === "string" || typeof bv === "string") {
          return safe(av).localeCompare(safe(bv)) * dir;
        }
        return (Number(av) - Number(bv)) * dir;
      });

      rows.forEach((a) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${esc(a.name)}</td>
          <td>${esc(usd(a.spent_usd))}</td>
          <td>${esc(usd(a.remaining_usd))}</td>
          <td>${esc(usd(a.budget_usd))}</td>
          <td>${esc(usd(a.reserved_usd))}</td>
          <td class="mono">${esc(a.burn)}µ/s</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderExecutionList(filtered, reservationMap) {
      const wrap = $("execution-list");
      wrap.innerHTML = "";
      setText("execution-count", `${filtered.length} execution${filtered.length === 1 ? "" : "s"}`);

      if (!filtered.length) {
        wrap.innerHTML = '<div class="empty">No executions match current filters.</div>';
        state.selectedExecutionId = null;
        renderExecutionDetail(null, null, []);
        return;
      }

      if (!state.selectedExecutionId || !filtered.some((e) => safe(e.execution_id) === state.selectedExecutionId)) {
        state.selectedExecutionId = safe(filtered[0].execution_id);
      }

      filtered.slice(0, 42).forEach((e) => {
        const execId = safe(e.execution_id);
        const res = reservationMap.get(execId);
        const stateName = safe(e.state || "UNKNOWN");
        const badgeClass = /COMMITTED/.test(stateName)
          ? "ok"
          : /RELEASED|DENIED|FAILED/.test(stateName)
          ? "bad"
          : "warn";

        const item = document.createElement("div");
        item.className = `item clickable ${execId === state.selectedExecutionId ? "selected" : ""}`;
        item.innerHTML = `
          <div class="item-head">
            <span class="mono">${esc(e.agent)}</span>
            <span class="pill ${badgeClass}">${esc(stateName)}</span>
          </div>
          <div class="item-title mono">${esc(execId)}</div>
          <div class="mono">endpoint=${esc(e.endpoint)} status=${esc(e.status_code ?? "-")}</div>
          <div class="mono">est=${esc(res?.estimated_micro ?? "-")} actual=${esc(res?.actual_micro ?? "-")}</div>
        `;
        item.addEventListener("click", () => {
          state.selectedExecutionId = execId;
          renderAllFromCache();
        });
        wrap.appendChild(item);
      });
    }

    function renderExecutionDetail(execution, reservation, events) {
      const panel = $("execution-detail");
      if (!execution) {
        panel.innerHTML = '<div class="empty">Select an execution to inspect details.</div>';
        return;
      }

      const details = {
        execution_id: execution.execution_id,
        agent: execution.agent,
        endpoint: execution.endpoint,
        state: execution.state,
        status_code: execution.status_code,
        created_at: execution.created_at,
        updated_at: execution.updated_at,
        terminal_at: execution.terminal_at,
        reservation: reservation || null,
        related_events: events.slice(0, 16),
      };

      panel.innerHTML = `
        <div><strong>${esc(execution.execution_id)}</strong></div>
        <div style="margin-top:6px;color:var(--muted)">Agent: ${esc(execution.agent)} | State: ${esc(execution.state)}</div>
        <pre>${esc(JSON.stringify(details, null, 2))}</pre>
      `;
    }

    function normalizeEvents(data) {
      const ledger = (data?.activity?.event_log || []).map((e) => ({
        source: "ledger",
        ts: e.ts,
        type: safe(e.event_type),
        agent: safe(e.agent || "-"),
        execution_id: safe(e.execution_id || "-"),
        summary: `seq=${safe(e.seq)} ${safe(e.event_type)}`,
      }));

      const compat = (data?.activity?.compat_events || []).map((e) => ({
        source: "compat",
        ts: e.timestamp,
        type: safe(e.action),
        agent: safe(e.agent || "-"),
        execution_id: "-",
        summary: `id=${safe(e.id)} cost=${safe(e.cost_micro)}µ`,
      }));

      return [...ledger, ...compat].sort((a, b) => safe(b.ts).localeCompare(safe(a.ts)));
    }

    function filterEvents(events) {
      const src = state.filters.eventSource;
      const query = lower(state.filters.query.trim());
      const focusSelected = $("focus-selected").checked && state.selectedExecutionId;

      return events.filter((e) => {
        if (src !== "all" && e.source !== src) return false;
        if (focusSelected && safe(e.execution_id) !== state.selectedExecutionId) return false;
        if (!query) return true;
        const hay = `${e.type} ${e.agent} ${e.execution_id} ${e.summary}`.toLowerCase();
        return hay.includes(query);
      });
    }

    function renderEvents(events) {
      const timeline = $("events-timeline");
      const tbody = $("event-rows");
      timeline.innerHTML = "";
      tbody.innerHTML = "";

      if (!events.length) {
        timeline.innerHTML = '<div class="empty">No events match current filters.</div>';
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No events match current filters.</td></tr>';
        return;
      }

      events.slice(0, 48).forEach((e) => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div class="item-head">
            <span class="mono">${esc(e.ts)}</span>
            <span class="pill ${e.source === "ledger" ? "ok" : "warn"}">${esc(e.source)}</span>
          </div>
          <div class="item-title mono">${esc(e.type)}</div>
          <div class="mono">agent=${esc(e.agent)} exec=${esc(e.execution_id)}</div>
          <div class="mono">${esc(e.summary)}</div>
        `;
        timeline.appendChild(item);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${esc(e.ts)}</td>
          <td>${esc(e.source)}</td>
          <td class="mono">${esc(e.type)}</td>
          <td class="mono">${esc(e.agent)}</td>
          <td class="mono">${esc(e.execution_id)}</td>
          <td class="mono">${esc(e.summary)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAllFromCache() {
      if (!state.raw) return;
      const { health, metrics, replay, activity } = state.raw;

      setText("daemon-status", safe(health.status || "unknown").toUpperCase());
      setText("daemon-version", `version=${safe(health.version || "?")}`);
      setText("total-requests", safe(metrics.total_requests ?? 0));
      setText("total-denials", `Denied budget=${safe(metrics.total_denied_budget ?? 0)} rate=${safe(metrics.total_denied_rate_limit ?? 0)}`);
      setText("spent-usd", usd(metrics.total_spent_global_usd));
      setText("exec-total", `Executions: ${safe(metrics.total_executions ?? 0)}`);
      setText("tenant-total", safe(metrics.total_tenants ?? 0));
      setText("project-total", `Projects: ${safe(metrics.total_projects ?? 0)}`);
      setText("stale-res", safe(metrics.stale_reservations ?? 0));
      setText("active-proc", `Active processes: ${safe(metrics.active_processes ?? 0)}`);

      const hashOk = !!replay.hash_chain_ok;
      const replayOk = !!replay.balance_replay_ok;
      setText("integrity-state", hashOk && replayOk ? "PASS" : "CHECK");
      $("hash-pill").className = pillClass(hashOk);
      $("hash-pill").textContent = hashOk ? "hash ok" : "hash fail";
      $("replay-pill").className = pillClass(replayOk);
      $("replay-pill").textContent = replayOk ? "replay ok" : "replay fail";

      createExecutionStateBars(metrics.execution_states || activity.execution_state_counts || {});
      createHistogram(metrics.usage_histogram || []);

      hydrateSelect("filter-state", Object.keys(metrics.execution_states || {}), state.filters.execState);
      hydrateSelect("filter-agent", (metrics.agents || []).map((a) => a.name), state.filters.agent);
      state.filters.execState = $("filter-state").value;
      state.filters.agent = $("filter-agent").value;

      renderAgents(metrics.agents || [], metrics.burn_rate_windows || {});

      const filteredExecutions = getFilteredExecutions(state.raw);
      const reservationMap = buildReservationMap(state.raw);
      renderExecutionList(filteredExecutions, reservationMap);

      const selected = filteredExecutions.find((e) => safe(e.execution_id) === state.selectedExecutionId) || null;
      const selectedReservation = selected ? reservationMap.get(safe(selected.execution_id)) : null;
      const selectedEvents = (activity.event_log || []).filter((e) => safe(e.execution_id) === safe(state.selectedExecutionId));
      renderExecutionDetail(selected, selectedReservation, selectedEvents);

      const mergedEvents = normalizeEvents(state.raw);
      renderEvents(filterEvents(mergedEvents));
    }

    async function loadData() {
      const res = await fetch("/admin/dashboard/data?limit=120");
      if (!res.ok) {
        throw new Error("Dashboard fetch failed");
      }
      return await res.json();
    }

    async function tick() {
      try {
        const data = await loadData();
        state.raw = data;
        renderAllFromCache();
        const critical = Number(data?.alert_summary?.critical || 0);
        const warning = Number(data?.alert_summary?.warning || 0);
        const suffix = critical > 0
          ? `alerts c=${critical} w=${warning}`
          : `alerts w=${warning}`;
        setStatusMessage(`last update ${new Date().toLocaleTimeString()} · ${suffix}`, critical > 0);
      } catch (err) {
        setStatusMessage(`update error ${new Date().toLocaleTimeString()}`, true);
      }
    }

    function restartPolling() {
      if (state.timer) clearInterval(state.timer);
      state.timer = setInterval(() => {
        if (state.polling && !document.hidden) tick();
      }, state.pollMs);
    }

    function bindControls() {
      $("toggle-refresh").addEventListener("click", () => {
        state.polling = !state.polling;
        $("toggle-refresh").textContent = state.polling ? "Pause" : "Resume";
        if (state.polling) tick();
      });

      $("refresh-now").addEventListener("click", () => tick());

      $("refresh-interval").addEventListener("change", (e) => {
        state.pollMs = Number(e.target.value || 3000);
        restartPolling();
      });

      $("filter-query").addEventListener("input", (e) => {
        state.filters.query = e.target.value || "";
        renderAllFromCache();
      });

      $("filter-state").addEventListener("change", (e) => {
        state.filters.execState = e.target.value;
        renderAllFromCache();
      });

      $("filter-agent").addEventListener("change", (e) => {
        state.filters.agent = e.target.value;
        renderAllFromCache();
      });

      $("filter-events").addEventListener("change", (e) => {
        state.filters.eventSource = e.target.value;
        renderAllFromCache();
      });

      $("focus-selected").addEventListener("change", () => renderAllFromCache());

      $("clear-filters").addEventListener("click", () => {
        state.filters.query = "";
        state.filters.execState = "ALL";
        state.filters.agent = "ALL";
        state.filters.eventSource = "all";
        $("filter-query").value = "";
        $("filter-events").value = "all";
        $("focus-selected").checked = false;
        renderAllFromCache();
      });

      document.querySelectorAll("th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          if (!key) return;
          if (state.sort.key === key) {
            state.sort.dir = state.sort.dir === "asc" ? "desc" : "asc";
          } else {
            state.sort.key = key;
            state.sort.dir = key === "name" ? "asc" : "desc";
          }
          renderAllFromCache();
        });
      });

      $("view-timeline").addEventListener("click", () => {
        state.eventView = "timeline";
        $("view-timeline").classList.add("active");
        $("view-table").classList.remove("active");
        $("events-timeline").classList.remove("hidden");
        $("events-table").classList.add("hidden");
      });

      $("view-table").addEventListener("click", () => {
        state.eventView = "table";
        $("view-table").classList.add("active");
        $("view-timeline").classList.remove("active");
        $("events-table").classList.remove("hidden");
        $("events-timeline").classList.add("hidden");
      });

      document.addEventListener("keydown", (e) => {
        if (e.target && ["INPUT", "TEXTAREA", "SELECT"].includes(e.target.tagName)) return;
        if (e.key.toLowerCase() === "r") {
          tick();
        }
        if (e.code === "Space") {
          e.preventDefault();
          $("toggle-refresh").click();
        }
      });
    }

    bindControls();
    tick();
    restartPolling();
  </script>
</body>
</html>
