<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AEX Backend Playout</title>
  <style>
    :root {
      --bg-0: #09121a;
      --bg-1: #0f1f2a;
      --bg-2: #152b38;
      --ink: #e8f2ef;
      --muted: #9fb4ad;
      --ok: #23bf73;
      --warn: #f0b429;
      --bad: #ff5d5d;
      --accent: #3bc3b1;
      --card: rgba(15, 31, 42, 0.78);
      --line: rgba(157, 187, 179, 0.2);
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 600px at 90% -5%, rgba(59, 195, 177, 0.22), transparent 55%),
        radial-gradient(1000px 520px at -10% 15%, rgba(42, 126, 184, 0.20), transparent 55%),
        linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 45%, var(--bg-2) 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 16px 44px;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      animation: rise 380ms ease-out;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      margin: 0;
      font-size: clamp(1.2rem, 2.6vw, 1.8rem);
      letter-spacing: 0.02em;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 2px;
      font-size: 0.92rem;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: 1px solid var(--line);
      color: var(--ink);
      background: rgba(24, 49, 65, 0.8);
      border-radius: 999px;
      padding: 8px 14px;
      font: 600 0.85rem/1 "Space Grotesk", "Avenir Next", sans-serif;
      cursor: pointer;
    }

    .btn:hover {
      border-color: rgba(59, 195, 177, 0.55);
      transform: translateY(-1px);
    }

    .grid {
      display: grid;
      gap: 14px;
      margin-bottom: 14px;
    }

    .kpis {
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      animation: rise 480ms ease-out;
    }

    .split {
      grid-template-columns: 1.25fr 1fr;
      animation: rise 560ms ease-out;
    }

    .full {
      animation: rise 650ms ease-out;
    }

    .card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(4px);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 0.92rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .kpi-label {
      color: var(--muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 5px;
    }

    .kpi-value {
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.05;
    }

    .kpi-foot {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--muted);
      min-height: 1em;
    }

    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.74rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      border: 1px solid transparent;
      font-family: "IBM Plex Mono", "JetBrains Mono", monospace;
    }

    .ok { color: var(--ok); border-color: rgba(35, 191, 115, 0.45); }
    .warn { color: var(--warn); border-color: rgba(240, 180, 41, 0.45); }
    .bad { color: var(--bad); border-color: rgba(255, 93, 93, 0.45); }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 0;
    }

    .states {
      display: grid;
      gap: 8px;
      max-height: 290px;
      overflow: auto;
      padding-right: 4px;
    }

    .state-bar-row {
      display: grid;
      grid-template-columns: 110px 1fr 52px;
      gap: 8px;
      align-items: center;
      font-size: 0.84rem;
    }

    .bar-track {
      width: 100%;
      height: 11px;
      border-radius: 8px;
      background: rgba(173, 207, 198, 0.14);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #23bf73, #3bc3b1);
      border-radius: 8px;
      transition: width 250ms ease;
    }

    .histogram {
      display: flex;
      align-items: end;
      gap: 4px;
      height: 178px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(18, 39, 51, 0.7);
    }

    .hist-bar {
      flex: 1;
      min-width: 8px;
      border-radius: 4px 4px 2px 2px;
      background: linear-gradient(180deg, #5dc6ff, #3bc3b1);
      opacity: 0.9;
      transition: height 200ms ease;
      position: relative;
    }

    .hist-bar:hover::after {
      content: attr(data-label) " • " attr(data-value);
      position: absolute;
      left: -12px;
      bottom: calc(100% + 5px);
      white-space: nowrap;
      padding: 3px 6px;
      border-radius: 6px;
      font-size: 0.68rem;
      border: 1px solid var(--line);
      background: rgba(6, 15, 22, 0.92);
    }

    .table-wrap {
      overflow: auto;
      max-height: 320px;
      border: 1px solid var(--line);
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(173, 207, 198, 0.12);
      text-align: left;
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(11, 25, 35, 0.95);
      color: var(--muted);
      font-weight: 600;
      z-index: 1;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.71rem;
    }

    .mono {
      font-family: "IBM Plex Mono", "JetBrains Mono", monospace;
      font-size: 0.78rem;
    }

    .timeline {
      display: grid;
      gap: 8px;
      max-height: 350px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      background: rgba(8, 20, 29, 0.78);
    }

    .item {
      border: 1px solid rgba(173, 207, 198, 0.15);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(13, 30, 41, 0.74);
    }

    .item-head {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.77rem;
      color: var(--muted);
    }

    .item-title {
      color: var(--ink);
      font-weight: 600;
      font-size: 0.84rem;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .empty {
      color: var(--muted);
      font-size: 0.84rem;
      padding: 8px 4px;
    }

    @media (max-width: 920px) {
      .split {
        grid-template-columns: 1fr;
      }
      .state-bar-row {
        grid-template-columns: 90px 1fr 45px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>AEX Backend Playout</h1>
        <div class="subtitle">Live control-plane + ledger visibility for local daemon activity.</div>
      </div>
      <div class="toolbar">
        <span id="last-updated" class="mono">updating...</span>
        <button id="toggle-refresh" class="btn" type="button">Pause</button>
        <button id="refresh-now" class="btn" type="button">Refresh</button>
      </div>
    </div>

    <div class="grid kpis">
      <div class="card">
        <div class="kpi-label">Daemon</div>
        <div id="daemon-status" class="kpi-value">-</div>
        <div id="daemon-version" class="kpi-foot mono"></div>
      </div>
      <div class="card">
        <div class="kpi-label">Requests</div>
        <div id="total-requests" class="kpi-value">-</div>
        <div id="total-denials" class="kpi-foot">-</div>
      </div>
      <div class="card">
        <div class="kpi-label">Spend</div>
        <div id="spent-usd" class="kpi-value">$0.000000</div>
        <div id="exec-total" class="kpi-foot">Executions: -</div>
      </div>
      <div class="card">
        <div class="kpi-label">Reservations</div>
        <div id="stale-res" class="kpi-value">-</div>
        <div id="active-proc" class="kpi-foot">Active processes: -</div>
      </div>
      <div class="card">
        <div class="kpi-label">Integrity</div>
        <div id="integrity-state" class="kpi-value">-</div>
        <div class="status-row">
          <span id="hash-pill" class="pill">hash</span>
          <span id="replay-pill" class="pill">replay</span>
        </div>
      </div>
    </div>

    <div class="grid split">
      <div class="card">
        <h2>Execution States</h2>
        <div id="state-bars" class="states"></div>
      </div>
      <div class="card">
        <h2>Requests Last 24h</h2>
        <div id="histogram" class="histogram"></div>
      </div>
    </div>

    <div class="grid split">
      <div class="card">
        <h2>Agent Financials</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Agent</th>
                <th>Spent</th>
                <th>Remaining</th>
                <th>Budget</th>
                <th>Reserved</th>
                <th>Burn (1m)</th>
              </tr>
            </thead>
            <tbody id="agent-rows"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2>Recent Executions</h2>
        <div id="execution-timeline" class="timeline"></div>
      </div>
    </div>

    <div class="grid full">
      <div class="card">
        <h2>Ledger & Control Events</h2>
        <div id="event-timeline" class="timeline"></div>
      </div>
    </div>
  </div>

  <script>
    const POLL_MS = 3000;
    let polling = true;
    let timer = null;

    const $ = (id) => document.getElementById(id);
    const safe = (v) => (v === null || v === undefined ? "" : String(v));
    const usd = (v) => `$${Number(v || 0).toFixed(6)}`;

    function pillClass(ok, unknown = false) {
      if (unknown) return "pill warn";
      return ok ? "pill ok" : "pill bad";
    }

    function setText(id, value) {
      $(id).textContent = value;
    }

    function createExecutionStateBars(stateMap) {
      const wrap = $("state-bars");
      wrap.innerHTML = "";

      const entries = Object.entries(stateMap || {});
      if (!entries.length) {
        wrap.innerHTML = '<div class="empty">No execution state data yet.</div>';
        return;
      }
      const max = Math.max(...entries.map(([, n]) => Number(n || 0)), 1);
      entries
        .sort((a, b) => Number(b[1]) - Number(a[1]))
        .forEach(([name, count]) => {
          const row = document.createElement("div");
          row.className = "state-bar-row";
          const width = Math.max(2, Math.round((Number(count || 0) / max) * 100));
          row.innerHTML = `
            <span class="mono">${safe(name)}</span>
            <span class="bar-track"><span class="bar-fill" style="width:${width}%"></span></span>
            <span class="mono">${safe(count)}</span>
          `;
          wrap.appendChild(row);
        });
    }

    function createHistogram(histogram) {
      const wrap = $("histogram");
      wrap.innerHTML = "";
      const rows = Array.isArray(histogram) ? histogram : [];
      if (!rows.length) {
        wrap.innerHTML = '<div class="empty">No usage histogram data yet.</div>';
        return;
      }
      const max = Math.max(...rows.map((r) => Number(r.requests || 0)), 1);
      rows.forEach((r) => {
        const bar = document.createElement("div");
        bar.className = "hist-bar";
        bar.style.height = `${Math.max(4, (Number(r.requests || 0) / max) * 100)}%`;
        bar.dataset.label = safe(r.hour);
        bar.dataset.value = `${safe(r.requests)} req`;
        wrap.appendChild(bar);
      });
    }

    function renderAgents(agents, burnRateWindows) {
      const tbody = $("agent-rows");
      tbody.innerHTML = "";
      if (!Array.isArray(agents) || !agents.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No agents found.</td></tr>';
        return;
      }
      agents
        .slice()
        .sort((a, b) => Number(b.spent_usd || 0) - Number(a.spent_usd || 0))
        .forEach((a) => {
          const burn = burnRateWindows?.[a.name]?.["1m"] ?? 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${safe(a.name)}</td>
            <td>${usd(a.spent_usd)}</td>
            <td>${usd(a.remaining_usd)}</td>
            <td>${usd(a.budget_usd)}</td>
            <td>${usd(a.reserved_usd)}</td>
            <td class="mono">${safe(burn)}µ/s</td>
          `;
          tbody.appendChild(tr);
        });
    }

    function renderExecutionTimeline(executions, reservations) {
      const wrap = $("execution-timeline");
      wrap.innerHTML = "";

      const resMap = new Map((reservations || []).map((r) => [r.execution_id, r]));
      const rows = (executions || []).slice(0, 28);
      if (!rows.length) {
        wrap.innerHTML = '<div class="empty">No execution activity yet.</div>';
        return;
      }

      rows.forEach((e) => {
        const res = resMap.get(e.execution_id);
        const state = safe(e.state || "UNKNOWN");
        const badgeClass = /COMMITTED/.test(state)
          ? "ok"
          : /RELEASED|DENIED|FAILED/.test(state)
          ? "bad"
          : "warn";
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div class="item-head">
            <span class="mono">${safe(e.agent)}</span>
            <span class="pill ${badgeClass}">${state}</span>
          </div>
          <div class="item-title mono">${safe(e.execution_id).slice(0, 24)}...</div>
          <div class="mono">endpoint=${safe(e.endpoint)} status=${safe(e.status_code ?? "-")}</div>
          <div class="mono">reserve=${safe(res?.estimated_micro ?? "-")} actual=${safe(res?.actual_micro ?? "-")}</div>
        `;
        wrap.appendChild(item);
      });
    }

    function renderEventTimeline(eventLog, compatEvents) {
      const wrap = $("event-timeline");
      wrap.innerHTML = "";

      const ledger = (eventLog || []).slice(0, 18).map((e) => ({
        ts: e.ts,
        title: `ledger.${safe(e.event_type)}`,
        sub: `seq=${safe(e.seq)} agent=${safe(e.agent ?? "-")} exec=${safe(e.execution_id ?? "-")}`,
      }));
      const compat = (compatEvents || []).slice(0, 14).map((e) => ({
        ts: e.timestamp,
        title: `event.${safe(e.action)}`,
        sub: `id=${safe(e.id)} agent=${safe(e.agent ?? "-")} cost=${safe(e.cost_micro)}µ`,
      }));

      const combined = [...ledger, ...compat]
        .sort((a, b) => safe(b.ts).localeCompare(safe(a.ts)))
        .slice(0, 28);

      if (!combined.length) {
        wrap.innerHTML = '<div class="empty">No ledger/control events yet.</div>';
        return;
      }

      combined.forEach((e) => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div class="item-head">
            <span class="mono">${safe(e.ts)}</span>
          </div>
          <div class="item-title mono">${safe(e.title)}</div>
          <div class="mono">${safe(e.sub)}</div>
        `;
        wrap.appendChild(item);
      });
    }

    async function loadData() {
      const [healthRes, metricsRes, replayRes, activityRes] = await Promise.all([
        fetch("/health"),
        fetch("/metrics"),
        fetch("/admin/replay"),
        fetch("/admin/activity?limit=60"),
      ]);

      if (!healthRes.ok || !metricsRes.ok || !replayRes.ok || !activityRes.ok) {
        throw new Error("Dashboard fetch failed");
      }

      const health = await healthRes.json();
      const metrics = await metricsRes.json();
      const replay = await replayRes.json();
      const activity = await activityRes.json();
      return { health, metrics, replay, activity };
    }

    function paint({ health, metrics, replay, activity }) {
      setText("daemon-status", safe(health.status || "unknown").toUpperCase());
      setText("daemon-version", `version=${safe(health.version || "?")}`);
      setText("total-requests", safe(metrics.total_requests ?? 0));
      setText(
        "total-denials",
        `Denied budget=${safe(metrics.total_denied_budget ?? 0)} rate=${safe(metrics.total_denied_rate_limit ?? 0)}`
      );
      setText("spent-usd", usd(metrics.total_spent_global_usd));
      setText("exec-total", `Executions: ${safe(metrics.total_executions ?? 0)}`);
      setText("stale-res", safe(metrics.stale_reservations ?? 0));
      setText("active-proc", `Active processes: ${safe(metrics.active_processes ?? 0)}`);

      const hashOk = !!replay.hash_chain_ok;
      const replayOk = !!replay.balance_replay_ok;
      setText("integrity-state", hashOk && replayOk ? "PASS" : "CHECK");
      $("hash-pill").className = pillClass(hashOk);
      $("hash-pill").textContent = hashOk ? "hash ok" : "hash fail";
      $("replay-pill").className = pillClass(replayOk);
      $("replay-pill").textContent = replayOk ? "replay ok" : "replay fail";

      createExecutionStateBars(metrics.execution_states || activity.execution_state_counts);
      createHistogram(metrics.usage_histogram || []);
      renderAgents(metrics.agents || [], metrics.burn_rate_windows || {});
      renderExecutionTimeline(activity.executions || [], activity.reservations || []);
      renderEventTimeline(activity.event_log || [], activity.compat_events || []);
      setText("last-updated", `last update ${new Date().toLocaleTimeString()}`);
    }

    async function tick() {
      try {
        const data = await loadData();
        paint(data);
      } catch (err) {
        setText("last-updated", `update error ${new Date().toLocaleTimeString()}`);
      }
    }

    function startPolling() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (polling) tick();
      }, POLL_MS);
    }

    $("toggle-refresh").addEventListener("click", () => {
      polling = !polling;
      $("toggle-refresh").textContent = polling ? "Pause" : "Resume";
      if (polling) tick();
    });
    $("refresh-now").addEventListener("click", () => tick());

    tick();
    startPolling();
  </script>
</body>
</html>
