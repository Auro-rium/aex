<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AEX Admin Command Center</title>
  <style>
    :root {
      --bg-0: #0c141d;
      --bg-1: #132436;
      --bg-2: #18364a;
      --ink: #e8f1ec;
      --muted: #9ab4a8;
      --line: rgba(170, 196, 185, 0.22);
      --ok: #2ac579;
      --warn: #e8b735;
      --bad: #ff6767;
      --accent: #3dc6b6;
      --accent-2: #67b5ff;
      --card: rgba(13, 30, 41, 0.82);
      --radius: 14px;
      --shadow: 0 18px 36px rgba(0, 0, 0, 0.34);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      background:
        radial-gradient(1100px 620px at 98% -12%, rgba(61, 198, 182, 0.22), transparent 55%),
        radial-gradient(980px 520px at -8% 20%, rgba(103, 181, 255, 0.18), transparent 55%),
        linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1380px;
      margin: 0 auto;
      padding: 22px 16px 38px;
    }

    .hero {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.2rem, 2.6vw, 1.9rem);
      letter-spacing: 0.02em;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 3px;
      font-size: 0.9rem;
      max-width: 760px;
    }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .grid { display: grid; gap: 12px; margin-bottom: 12px; }
    .two { grid-template-columns: 1fr 1fr; }
    .three { grid-template-columns: repeat(3, 1fr); }
    .full { grid-template-columns: 1fr; }

    .card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 13px;
      backdrop-filter: blur(4px);
    }

    .card h2 {
      margin: 0 0 8px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      align-items: end;
      margin-bottom: 8px;
    }

    .input, .btn, .select {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: rgba(17, 39, 53, 0.84);
      color: var(--ink);
      padding: 8px 10px;
      font-size: 0.82rem;
      font-family: "Space Grotesk", "Avenir Next", sans-serif;
    }

    .input, .select { width: 100%; }
    .input:focus, .select:focus {
      outline: none;
      border-color: rgba(103, 181, 255, 0.8);
      box-shadow: 0 0 0 2px rgba(103, 181, 255, 0.2);
    }

    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: transform 160ms ease, border-color 160ms ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(61, 198, 182, 0.75);
    }

    .btn.warn { border-color: rgba(232, 183, 53, 0.65); }
    .btn.bad { border-color: rgba(255, 103, 103, 0.75); }

    .label {
      color: var(--muted);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
      display: block;
    }

    .mono { font-family: "IBM Plex Mono", "JetBrains Mono", monospace; font-size: 0.77rem; }

    .status {
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.78rem;
      min-height: 1em;
    }

    .ok { color: var(--ok); }
    .warn-t { color: var(--warn); }
    .bad-t { color: var(--bad); }

    .table-wrap {
      overflow: auto;
      max-height: 340px;
      border: 1px solid var(--line);
      border-radius: 10px;
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.79rem; }
    th, td {
      border-bottom: 1px solid rgba(170, 196, 185, 0.14);
      text-align: left;
      padding: 7px 8px;
      white-space: nowrap;
      vertical-align: top;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(11, 25, 35, 0.96);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.68rem;
    }

    .output {
      min-height: 120px;
      max-height: 300px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      background: rgba(10, 22, 31, 0.8);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .pill {
      display: inline-block;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
    }

    .tiny-btn {
      padding: 4px 7px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(18, 42, 58, 0.82);
      color: var(--ink);
      cursor: pointer;
      font-size: 0.7rem;
      margin-right: 4px;
    }

    .tiny-btn.bad { border-color: rgba(255, 103, 103, 0.75); }

    @media (max-width: 1100px) {
      .two, .three { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>AEX Admin Command Center</h1>
        <div class="subtitle">UI replacement for CLI: connect DB, manage tenants/projects/agents/policies, run replay/audit, migrations, and plugin ops.</div>
      </div>
      <div class="toolbar">
        <a class="btn" href="/dashboard">Dashboard</a>
        <input id="admin-key" class="input mono" type="password" placeholder="admin key (if enabled)">
        <button id="btn-system-refresh" class="btn" type="button">Refresh System Info</button>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>System + DB Connection</h2>
        <div class="row">
          <div>
            <label class="label" for="db-dsn-test">Test DB DSN</label>
            <input id="db-dsn-test" class="input mono" placeholder="postgresql://...">
          </div>
          <button id="btn-db-test" class="btn" type="button">Test DSN</button>
          <button id="btn-db-set" class="btn warn" type="button">Set Runtime DSN</button>
        </div>
        <div id="system-status" class="status mono"></div>
        <pre id="system-output" class="output mono">{}</pre>
      </div>

      <div class="card">
        <h2>Tenant + Project</h2>
        <div class="row">
          <div>
            <label class="label" for="tenant-id">Tenant ID</label>
            <input id="tenant-id" class="input mono" value="default">
          </div>
          <div>
            <label class="label" for="tenant-name">Tenant Name</label>
            <input id="tenant-name" class="input" placeholder="Tenant default">
          </div>
          <button id="btn-tenant-upsert" class="btn" type="button">Create / Update Tenant</button>
        </div>
        <div class="row">
          <div>
            <label class="label" for="project-id">Project ID</label>
            <input id="project-id" class="input mono" value="default">
          </div>
          <div>
            <label class="label" for="project-name">Project Name</label>
            <input id="project-name" class="input" placeholder="Project default">
          </div>
          <button id="btn-project-upsert" class="btn" type="button">Create / Update Project</button>
        </div>
        <div class="row">
          <button id="btn-load-tenants" class="btn" type="button">Load Tenants</button>
          <button id="btn-load-projects" class="btn" type="button">Load Projects</button>
        </div>
        <pre id="tenant-output" class="output mono">[]</pre>
      </div>
    </div>

    <div class="grid full">
      <div class="card">
        <h2>Agents (Create / Rotate / State / Delete)</h2>
        <div class="row">
          <div><label class="label" for="agent-name">Name</label><input id="agent-name" class="input mono" placeholder="agent-prod"></div>
          <div><label class="label" for="agent-budget">Budget USD</label><input id="agent-budget" class="input mono" type="number" step="0.01" value="20"></div>
          <div><label class="label" for="agent-rpm">RPM</label><input id="agent-rpm" class="input mono" type="number" value="240"></div>
          <div><label class="label" for="agent-scope">Scope</label><select id="agent-scope" class="select mono"><option value="execution" selected>execution</option><option value="read-only">read-only</option></select></div>
          <div><label class="label" for="agent-passthrough">Passthrough</label><select id="agent-passthrough" class="select mono"><option value="0" selected>off</option><option value="1">on</option></select></div>
          <button id="btn-agent-create" class="btn" type="button">Create Agent</button>
        </div>
        <div class="row">
          <button id="btn-agents-load" class="btn" type="button">Load Agents</button>
          <button id="btn-agent-state" class="btn warn" type="button">Set Agent State</button>
          <button id="btn-agent-rotate" class="btn" type="button">Rotate Token</button>
          <button id="btn-agent-delete" class="btn bad" type="button">Delete Agent</button>
          <button id="btn-agent-show" class="btn" type="button">Show Agent Details</button>
        </div>
        <div class="row">
          <div><label class="label" for="agent-target">Target Agent</label><input id="agent-target" class="input mono" placeholder="agent name"></div>
          <div><label class="label" for="agent-new-state">New State</label><input id="agent-new-state" class="input mono" placeholder="PAUSED"></div>
          <div><label class="label" for="agent-state-reason">Reason</label><input id="agent-state-reason" class="input" value="ui transition"></div>
          <div><label class="label" for="agent-ttl">Token TTL Hours (rotate)</label><input id="agent-ttl" class="input mono" type="number" step="0.001" placeholder="optional"></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Tenant</th><th>Project</th><th>Budget</th><th>Spent</th><th>State</th><th>Scope</th><th>Caps</th></tr></thead>
            <tbody id="agents-table"></tbody>
          </table>
        </div>
        <pre id="agent-output" class="output mono">{}</pre>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>Policies</h2>
        <div class="row">
          <div><label class="label" for="policy-id">Policy ID</label><input id="policy-id" class="input mono" placeholder="prod_safe"></div>
          <div><label class="label" for="policy-budget">Budget USD</label><input id="policy-budget" class="input mono" type="number" step="0.01" value="50"></div>
          <div><label class="label" for="policy-max-steps">Max Steps</label><input id="policy-max-steps" class="input mono" type="number" value="100"></div>
          <button id="btn-policy-upsert" class="btn" type="button">Create / Update Policy</button>
        </div>
        <div class="row">
          <div><label class="label" for="policy-allow">Allow Tools (csv)</label><input id="policy-allow" class="input mono" placeholder="search,github"></div>
          <div><label class="label" for="policy-deny">Deny Tools (csv)</label><input id="policy-deny" class="input mono" value="shell,db_write"></div>
          <div><label class="label" for="policy-danger">Dangerous Ops</label><select id="policy-danger" class="select mono"><option value="0" selected>off</option><option value="1">on</option></select></div>
          <div><label class="label" for="policy-approval">Require Approval</label><select id="policy-approval" class="select mono"><option value="1" selected>on</option><option value="0">off</option></select></div>
        </div>
        <div class="row">
          <button id="btn-policy-load" class="btn" type="button">Load Policies</button>
          <button id="btn-policy-delete" class="btn bad" type="button">Delete Policy</button>
        </div>
        <pre id="policy-output" class="output mono">[]</pre>
      </div>

      <div class="card">
        <h2>Audit + Replay</h2>
        <div class="row">
          <button id="btn-audit" class="btn" type="button">Run Audit</button>
          <button id="btn-replay" class="btn" type="button">Run Replay Verification</button>
        </div>
        <pre id="integrity-output" class="output mono">{}</pre>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>Migrations</h2>
        <div class="row">
          <div><label class="label" for="mig-tag">Tag</label><input id="mig-tag" class="input mono" placeholder="optional"></div>
          <button id="btn-mig-snapshot" class="btn" type="button">Snapshot</button>
          <button id="btn-mig-apply" class="btn warn" type="button">Apply Migrations</button>
          <button id="btn-mig-tags" class="btn" type="button">List Tags</button>
        </div>
        <div class="row">
          <div><label class="label" for="mig-rollback-tag">Rollback Tag</label><input id="mig-rollback-tag" class="input mono" placeholder="tag required"></div>
          <button id="btn-mig-rollback" class="btn bad" type="button">Rollback</button>
          <div><label class="label" for="mig-snapshot-first">Snapshot Before Apply</label><select id="mig-snapshot-first" class="select mono"><option value="1" selected>yes</option><option value="0">no</option></select></div>
        </div>
        <pre id="migration-output" class="output mono">{}</pre>
      </div>

      <div class="card">
        <h2>Plugins</h2>
        <div class="row">
          <div><label class="label" for="plugin-manifest">Manifest Path</label><input id="plugin-manifest" class="input mono" placeholder="/path/manifest.yaml"></div>
          <div><label class="label" for="plugin-package">Package Path</label><input id="plugin-package" class="input mono" placeholder="/path/plugin.whl"></div>
          <button id="btn-plugin-install" class="btn" type="button">Install Plugin</button>
        </div>
        <div class="row">
          <div><label class="label" for="plugin-name">Plugin Name</label><input id="plugin-name" class="input mono" placeholder="tool_name"></div>
          <button id="btn-plugin-enable" class="btn" type="button">Enable</button>
          <button id="btn-plugin-disable" class="btn bad" type="button">Disable</button>
          <button id="btn-plugin-list" class="btn" type="button">List Plugins</button>
        </div>
        <pre id="plugin-output" class="output mono">[]</pre>
      </div>
    </div>

  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(id, text, tone = "") {
      const node = $(id);
      if (!node) return;
      node.textContent = text;
      node.className = `status mono ${tone}`;
    }

    function adminHeaders() {
      const key = ($("admin-key").value || "").trim();
      const headers = { "Content-Type": "application/json" };
      if (key) headers["x-aex-admin-key"] = key;
      return headers;
    }

    async function api(method, url, body) {
      const options = { method, headers: adminHeaders() };
      if (body !== undefined) options.body = JSON.stringify(body);
      const res = await fetch(url, options);
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch (_) { data = { raw: text }; }
      if (!res.ok) {
        throw new Error(typeof data.detail === "string" ? data.detail : `${res.status} ${text}`);
      }
      return data;
    }

    function csvToList(value) {
      return String(value || "")
        .split(",")
        .map((v) => v.trim())
        .filter(Boolean);
    }

    function renderAgentsTable(items) {
      const body = $("agents-table");
      body.innerHTML = "";
      if (!Array.isArray(items) || !items.length) {
        body.innerHTML = '<tr><td colspan="8" class="mono">No agents found</td></tr>';
        return;
      }
      for (const a of items) {
        const caps = [];
        if (!a.allow_streaming) caps.push("!stream");
        if (!a.allow_tools) caps.push("!tools");
        if (a.strict_mode) caps.push("STRICT");
        if (a.allow_passthrough) caps.push("PT");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${a.name || ""}</td>
          <td class="mono">${a.tenant_id || ""}</td>
          <td class="mono">${a.project_id || ""}</td>
          <td>${((Number(a.budget_micro || 0)) / 1e6).toFixed(4)}</td>
          <td>${((Number(a.spent_micro || 0)) / 1e6).toFixed(4)}</td>
          <td><span class="pill mono">${a.lifecycle_state || "READY"}</span></td>
          <td class="mono">${a.token_scope || "execution"}</td>
          <td class="mono">${caps.join(" ") || "-"}</td>
        `;
        body.appendChild(tr);
      }
    }

    async function refreshSystemInfo() {
      try {
        const data = await api("GET", "/admin/ui/system/info");
        $("system-output").textContent = JSON.stringify(data, null, 2);
        setStatus("system-status", "System info loaded", "ok");
      } catch (err) {
        setStatus("system-status", `System info failed: ${err.message}`, "bad-t");
      }
    }

    async function loadTenantsAndProjects() {
      try {
        const tenants = await api("GET", "/admin/ui/tenants");
        const projects = await api("GET", "/admin/ui/projects");
        $("tenant-output").textContent = JSON.stringify({ tenants: tenants.items, projects: projects.items }, null, 2);
      } catch (err) {
        $("tenant-output").textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    }

    async function loadAgents() {
      try {
        const data = await api("GET", "/admin/ui/agents");
        renderAgentsTable(data.items || []);
        $("agent-output").textContent = JSON.stringify({ count: (data.items || []).length }, null, 2);
      } catch (err) {
        $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    }

    async function loadPolicies() {
      try {
        const data = await api("GET", "/admin/ui/policies");
        $("policy-output").textContent = JSON.stringify(data.items || [], null, 2);
      } catch (err) {
        $("policy-output").textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    }

    async function loadPlugins() {
      try {
        const data = await api("GET", "/admin/ui/plugins");
        $("plugin-output").textContent = JSON.stringify(data.items || [], null, 2);
      } catch (err) {
        $("plugin-output").textContent = JSON.stringify({ error: err.message }, null, 2);
      }
    }

    function bind() {
      const adminKey = $("admin-key");
      adminKey.value = localStorage.getItem("aex_admin_key") || "";
      adminKey.addEventListener("change", () => {
        localStorage.setItem("aex_admin_key", adminKey.value || "");
      });

      $("btn-system-refresh").addEventListener("click", refreshSystemInfo);

      $("btn-db-test").addEventListener("click", async () => {
        try {
          const dsn = $("db-dsn-test").value || "";
          const data = await api("POST", "/admin/ui/db/test", { dsn });
          $("system-output").textContent = JSON.stringify(data, null, 2);
          setStatus("system-status", data.ok ? "DSN connection ok" : "DSN connection failed", data.ok ? "ok" : "bad-t");
        } catch (err) {
          setStatus("system-status", `DSN test failed: ${err.message}`, "bad-t");
        }
      });

      $("btn-db-set").addEventListener("click", async () => {
        try {
          const dsn = $("db-dsn-test").value || "";
          const data = await api("POST", "/admin/ui/system/set-db-dsn", { dsn, verify_connection: true });
          $("system-output").textContent = JSON.stringify(data, null, 2);
          setStatus("system-status", data.ok ? "Runtime DB DSN updated" : "Runtime DB DSN update failed", data.ok ? "ok" : "bad-t");
        } catch (err) {
          setStatus("system-status", `Set DB DSN failed: ${err.message}`, "bad-t");
        }
      });

      $("btn-tenant-upsert").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/tenants", {
            tenant_id: $("tenant-id").value,
            name: $("tenant-name").value,
          });
          $("tenant-output").textContent = JSON.stringify(data, null, 2);
          await loadTenantsAndProjects();
        } catch (err) {
          $("tenant-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-project-upsert").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/projects", {
            tenant_id: $("tenant-id").value,
            project_id: $("project-id").value,
            name: $("project-name").value,
          });
          $("tenant-output").textContent = JSON.stringify(data, null, 2);
          await loadTenantsAndProjects();
        } catch (err) {
          $("tenant-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-load-tenants").addEventListener("click", loadTenantsAndProjects);
      $("btn-load-projects").addEventListener("click", loadTenantsAndProjects);

      $("btn-agent-create").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/agents", {
            name: $("agent-name").value,
            budget_usd: Number($("agent-budget").value || 20),
            rpm_limit: Number($("agent-rpm").value || 240),
            tenant_id: $("tenant-id").value || "default",
            project_id: $("project-id").value || "default",
            token_scope: $("agent-scope").value || "execution",
            allow_passthrough: $("agent-passthrough").value === "1",
          });
          $("agent-output").textContent = JSON.stringify(data, null, 2);
          $("agent-target").value = data.name || "";
          await loadAgents();
        } catch (err) {
          $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-agents-load").addEventListener("click", loadAgents);

      $("btn-agent-show").addEventListener("click", async () => {
        try {
          const name = ($("agent-target").value || "").trim();
          const data = await api("GET", `/admin/ui/agents/${encodeURIComponent(name)}?include_token=true`);
          $("agent-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-agent-rotate").addEventListener("click", async () => {
        try {
          const name = ($("agent-target").value || "").trim();
          const ttlRaw = ($("agent-ttl").value || "").trim();
          const data = await api("POST", `/admin/ui/agents/${encodeURIComponent(name)}/rotate-token`, {
            token_ttl_hours: ttlRaw ? Number(ttlRaw) : null,
          });
          $("agent-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-agent-state").addEventListener("click", async () => {
        try {
          const name = ($("agent-target").value || "").trim();
          const toState = ($("agent-new-state").value || "").trim();
          const reason = $("agent-state-reason").value || "ui transition";
          const data = await api("POST", `/admin/ui/agents/${encodeURIComponent(name)}/state`, {
            to_state: toState,
            reason,
          });
          $("agent-output").textContent = JSON.stringify(data, null, 2);
          await loadAgents();
        } catch (err) {
          $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-agent-delete").addEventListener("click", async () => {
        try {
          const name = ($("agent-target").value || "").trim();
          if (!window.confirm(`Delete agent ${name}?`)) return;
          const data = await api("DELETE", `/admin/ui/agents/${encodeURIComponent(name)}`);
          $("agent-output").textContent = JSON.stringify(data, null, 2);
          await loadAgents();
        } catch (err) {
          $("agent-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-policy-upsert").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/policies", {
            policy_id: $("policy-id").value,
            budget_usd: Number($("policy-budget").value || 50),
            max_steps: Number($("policy-max-steps").value || 100),
            allow_tools: csvToList($("policy-allow").value),
            deny_tools: csvToList($("policy-deny").value),
            dangerous_ops: $("policy-danger").value === "1",
            require_approval_for_destructive_ops: $("policy-approval").value === "1",
          });
          $("policy-output").textContent = JSON.stringify(data, null, 2);
          await loadPolicies();
        } catch (err) {
          $("policy-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-policy-load").addEventListener("click", loadPolicies);

      $("btn-policy-delete").addEventListener("click", async () => {
        try {
          const policyId = ($("policy-id").value || "").trim();
          if (!window.confirm(`Delete policy ${policyId}?`)) return;
          const data = await api("DELETE", `/admin/ui/policies/${encodeURIComponent(policyId)}`);
          $("policy-output").textContent = JSON.stringify(data, null, 2);
          await loadPolicies();
        } catch (err) {
          $("policy-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-audit").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/audit", {});
          $("integrity-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("integrity-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-replay").addEventListener("click", async () => {
        try {
          const data = await api("GET", "/admin/ui/replay");
          $("integrity-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("integrity-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-mig-tags").addEventListener("click", async () => {
        try {
          const data = await api("GET", "/admin/ui/migrate/tags");
          $("migration-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("migration-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-mig-snapshot").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/migrate/snapshot", {
            tag: ($("mig-tag").value || "").trim() || null,
          });
          $("migration-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("migration-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-mig-apply").addEventListener("click", async () => {
        try {
          if (!window.confirm("Apply migrations now?")) return;
          const data = await api("POST", "/admin/ui/migrate/apply", {
            snapshot_first: $("mig-snapshot-first").value === "1",
            tag: ($("mig-tag").value || "").trim() || null,
          });
          $("migration-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("migration-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-mig-rollback").addEventListener("click", async () => {
        try {
          const tag = ($("mig-rollback-tag").value || "").trim();
          if (!tag) {
            $("migration-output").textContent = JSON.stringify({ error: "rollback tag is required" }, null, 2);
            return;
          }
          if (!window.confirm(`Rollback to tag ${tag}?`)) return;
          const data = await api("POST", "/admin/ui/migrate/rollback", { tag });
          $("migration-output").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          $("migration-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-plugin-list").addEventListener("click", loadPlugins);

      $("btn-plugin-install").addEventListener("click", async () => {
        try {
          const data = await api("POST", "/admin/ui/plugins/install", {
            manifest_path: $("plugin-manifest").value,
            package_path: $("plugin-package").value,
          });
          $("plugin-output").textContent = JSON.stringify(data, null, 2);
          await loadPlugins();
        } catch (err) {
          $("plugin-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-plugin-enable").addEventListener("click", async () => {
        try {
          const name = ($("plugin-name").value || "").trim();
          const data = await api("POST", `/admin/ui/plugins/${encodeURIComponent(name)}/enable`, {});
          $("plugin-output").textContent = JSON.stringify(data, null, 2);
          await loadPlugins();
        } catch (err) {
          $("plugin-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });

      $("btn-plugin-disable").addEventListener("click", async () => {
        try {
          const name = ($("plugin-name").value || "").trim();
          const data = await api("POST", `/admin/ui/plugins/${encodeURIComponent(name)}/disable`, {});
          $("plugin-output").textContent = JSON.stringify(data, null, 2);
          await loadPlugins();
        } catch (err) {
          $("plugin-output").textContent = JSON.stringify({ error: err.message }, null, 2);
        }
      });
    }

    bind();
    refreshSystemInfo();
    loadTenantsAndProjects();
    loadAgents();
    loadPolicies();
    loadPlugins();
  </script>
</body>
</html>
