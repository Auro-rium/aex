# Local dev against Neon PostgreSQL â€” no local Postgres container.
# Set AEX_PG_DSN to your Neon connection string before running:
#   export AEX_PG_DSN="postgresql://<user>:<pass>@<neon-host>/<db>?sslmode=require"
#   docker compose up

services:
  aex:
    build: .
    restart: unless-stopped
    environment:
      AEX_PG_DSN: ${AEX_PG_DSN:?AEX_PG_DSN must be set to your Neon DSN}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AEX_ADMIN_CONTROL_KEY: ${AEX_ADMIN_CONTROL_KEY:-}
      AEX_STARTUP_STRICT: ${AEX_STARTUP_STRICT:-1}
      AEX_LOG_LEVEL: ${AEX_LOG_LEVEL:-INFO}
      AEX_ALERT_STALE_RESERVATIONS: 20
      AEX_ALERT_NON_TERMINAL_EXECUTIONS: 50
      AEX_ALERT_DENIED_RATIO: 0.50
      AEX_ALERT_PROVIDER_429: 30
      AEX_ALERT_WINDOW_MINUTES: 10
    ports:
      - "${AEX_HTTP_PORT:-9000}:9000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:9000/ready', timeout=3).status == 200 else 1)"]
      interval: 15s
      timeout: 5s
      retries: 5
